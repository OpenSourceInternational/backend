/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(o,s){function a(t){try{l(i.next(t))}catch(t){s(t)}}function c(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}l((i=i.apply(t,e||[])).next())}))};define(["require","exports","jquery","TYPO3/CMS/Core/Ajax/AjaxRequest","./ContextMenuActions"],(function(t,e,n,i,o){"use strict";class s{constructor(){this.mousePos={X:null,Y:null},this.delayContextMenuHide=!1,this.record={uid:null,table:null},this.storeMousePositionEvent=t=>{this.mousePos={X:t.pageX,Y:t.pageY},this.mouseOutFromMenu("#contentMenu0"),this.mouseOutFromMenu("#contentMenu1")},this.initializeEvents()}static drawActionItem(t){const e=t.additionalAttributes||{};let n="";for(const t of Object.entries(e)){const[e,i]=t;n+=" "+e+'="'+i+'"'}return'<a class="list-group-item" data-callback-action="'+t.callbackAction+'"'+n+'><span class="list-group-item-icon">'+t.icon+"</span> "+t.label+"</a>"}static within(t,e,n){const i=t.offset();return n>=i.top&&n<i.top+t.height()&&e>=i.left&&e<i.left+t.width()}static initializeContextMenuContainer(){if(0===n("#contentMenu0").length){const t='<div id="contentMenu0" class="context-menu"></div><div id="contentMenu1" class="context-menu" style="display: block;"></div>';n("body").append(t)}}initializeEvents(){n(document).on("click contextmenu",".t3js-contextmenutrigger",t=>{const e=n(t.currentTarget);e.prop("onclick")&&"click"===t.type||(t.preventDefault(),this.show(e.data("table"),e.data("uid"),e.data("context"),e.data("iteminfo"),e.data("parameters")))}),n(document).on("mousemove",this.storeMousePositionEvent)}show(t,e,n,i,o){this.record={table:t,uid:e};let s="";void 0!==t&&(s+="table="+encodeURIComponent(t)),void 0!==e&&(s+=(s.length>0?"&":"")+"uid="+e),void 0!==n&&(s+=(s.length>0?"&":"")+"context="+n),void 0!==i&&(s+=(s.length>0?"&":"")+"enDisItems="+i),void 0!==o&&(s+=(s.length>0?"&":"")+"addParams="+o),this.fetch(s)}fetch(t){let e=TYPO3.settings.ajaxUrls.contextmenu;new i(e).withQueryArguments(t).get().then(t=>__awaiter(this,void 0,void 0,(function*(){const e=yield t.resolve();void 0!==t&&Object.keys(t).length>0&&this.populateData(e,0)})))}populateData(e,i){s.initializeContextMenuContainer();const a=n("#contentMenu"+i);if(a.length&&(0===i||n("#contentMenu"+(i-1)).is(":visible"))){const s=this.drawMenu(e,i);a.html('<div class="list-group">'+s+"</div>"),n("a.list-group-item",a).click(e=>{e.preventDefault();const s=n(e.currentTarget);if(s.hasClass("list-group-item-submenu"))return void this.openSubmenu(i,s);const a=s.data("callback-action"),c=s.data("callback-module");s.data("callback-module")?t([c],t=>{t[a].bind(s)(this.record.table,this.record.uid)}):o&&"function"==typeof o[a]?o[a].bind(s)(this.record.table,this.record.uid):console.log("action: "+a+" not found"),this.hideAll()}),a.css(this.getPosition(a)).show()}}openSubmenu(t,e){const i=n("#contentMenu"+(t+1)).html("");e.next().find(".list-group").clone(!0).appendTo(i),i.css(this.getPosition(i)).show()}getPosition(t){let e=this.mousePos.X,i=this.mousePos.Y;const o=n(window).width()-20,s=n(window).height(),a=t.width(),c=t.height(),l=this.mousePos.X-n(document).scrollLeft(),u=this.mousePos.Y-n(document).scrollTop();return s-c<u&&(u>c?i-=c-10:i+=s-c-u),o-a<l&&(l>a?e-=a-10:o-a-l<n(document).scrollLeft()?e=n(document).scrollLeft():e+=o-a-l),{left:e+"px",top:i+"px"}}drawMenu(t,e){let n="";for(let i of Object.values(t))if("item"===i.type)n+=s.drawActionItem(i);else if("divider"===i.type)n+='<a class="list-group-item list-group-item-divider"></a>';else if("submenu"===i.type||i.childItems){n+='<a class="list-group-item list-group-item-submenu"><span class="list-group-item-icon">'+i.icon+"</span> "+i.label+'&nbsp;&nbsp;<span class="fa fa-caret-right"></span></a>',n+='<div class="context-menu contentMenu'+(e+1)+'" style="display:none;"><div class="list-group">'+this.drawMenu(i.childItems,1)+"</div></div>"}return n}mouseOutFromMenu(t){const e=n(t);e.length>0&&e.is(":visible")&&!s.within(e,this.mousePos.X,this.mousePos.Y)?this.hide(t):e.length>0&&e.is(":visible")&&(this.delayContextMenuHide=!0)}hide(t){this.delayContextMenuHide=!1,window.setTimeout(()=>{this.delayContextMenuHide||n(t).hide()},500)}hideAll(){this.hide("#contentMenu0"),this.hide("#contentMenu1")}}return new s}));