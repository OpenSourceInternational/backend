/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","./Modal","TYPO3/CMS/Core/Contrib/imagesloaded.pkgd.min","jquery-ui/draggable","jquery-ui/resizable"],function(a,b,c,d,e){"use strict";var f=function(){function a(){var b=this;this.cropImageContainerSelector="#t3js-crop-image-container",this.cropImageSelector="#t3js-crop-image",this.coverAreaSelector=".t3js-cropper-cover-area",this.cropInfoSelector=".t3js-cropper-info-crop",this.focusAreaSelector="#t3js-cropper-focus-area",this.defaultFocusArea={height:1/3,width:1/3,x:0,y:0},this.defaultOpts={autoCrop:!0,autoCropArea:"0.7",dragMode:"crop",guides:!0,responsive:!0,viewMode:1,zoomable:!1},this.resizeTimeout=450,this.cropBuiltHandler=function(){var d=b.cropper.cropper("getImageData"),e=b.currentModal.find(b.cropImageSelector);b.imageOriginalSizeFactor=e.data("originalWidth")/d.naturalWidth,b.cropVariantTriggers.each(function(a,e){var f=c(e).attr("data-crop-variant-id"),g=b.convertRelativeToAbsoluteCropArea(b.data[f].cropArea,d),h=c.extend(!0,{},b.data[f],{cropArea:g});b.updatePreviewThumbnail(h,c(e))}),b.currentCropVariant.cropArea=b.convertRelativeToAbsoluteCropArea(b.currentCropVariant.cropArea,d),b.cropBox=b.currentModal.find(".cropper-crop-box"),b.setCropArea(b.currentCropVariant.cropArea),b.currentCropVariant.coverAreas&&b.initCoverAreas(b.cropBox,b.currentCropVariant.coverAreas),b.currentCropVariant.focusArea&&(a.isEmptyArea(b.currentCropVariant.focusArea)&&(b.currentCropVariant.focusArea=c.extend(!0,{},b.defaultFocusArea)),b.initFocusArea(b.cropBox),b.scaleAndMoveFocusArea(b.currentCropVariant.focusArea)),b.currentCropVariant.selectedRatio&&(b.setAspectRatio(b.currentCropVariant.allowedAspectRatios[b.currentCropVariant.selectedRatio]),b.setCropArea(b.currentCropVariant.cropArea),b.currentModal.find("[data-option='"+b.currentCropVariant.selectedRatio+"']").addClass("active")),b.cropperCanvas.addClass("is-visible")},this.cropMoveHandler=function(a){b.currentCropVariant.cropArea=c.extend(!0,b.currentCropVariant.cropArea,{height:Math.floor(a.height),width:Math.floor(a.width),x:Math.floor(a.x),y:Math.floor(a.y)}),b.updatePreviewThumbnail(b.currentCropVariant,b.activeCropVariantTrigger),b.updateCropVariantData(b.currentCropVariant);var d=Math.round(b.currentCropVariant.cropArea.width*b.imageOriginalSizeFactor),e=Math.round(b.currentCropVariant.cropArea.height*b.imageOriginalSizeFactor);b.cropInfo.text(d+"Ã—"+e+" px")},this.cropStartHandler=function(){b.currentCropVariant.focusArea&&(b.focusArea.draggable("option","disabled",!0),b.focusArea.resizable("option","disabled",!0))},this.cropEndHandler=function(){b.currentCropVariant.focusArea&&(b.focusArea.draggable("option","disabled",!1),b.focusArea.resizable("option","disabled",!1))},c(window).resize(function(){b.cropper&&b.cropper.cropper("destroy")}),this.resizeEnd(function(){b.cropper&&b.init()})}return a.isEmptyArea=function(a){return c.isEmptyObject(a)},a.wait=function(a,b){window.setTimeout(a,b)},a.toCssPercent=function(a){return 100*a+"%"},a.serializeCropVariants=function(a){var b=function(a,b){return"id"===a||"title"===a||"allowedAspectRatios"===a||"coverAreas"===a?void 0:b};return JSON.stringify(a,b)},a.prototype.initializeTrigger=function(){var a=this,b=function(b){b.preventDefault(),a.trigger=c(b.currentTarget),a.show()};c(".t3js-image-manipulation-trigger").off("click").click(b)},a.prototype.initializeCropperModal=function(){var a=this,b=this.currentModal.find(this.cropImageSelector);e(b,function(){setTimeout(function(){a.init()},100)})},a.prototype.show=function(){var a=this,b=this.trigger.data("modalTitle"),c=this.trigger.data("buttonPreviewText"),e=this.trigger.data("buttonDismissText"),f=this.trigger.data("buttonSaveText"),g=this.trigger.data("url"),h=this.initializeCropperModal.bind(this);this.currentModal=d.advanced({additionalCssClasses:["modal-image-manipulation"],ajaxCallback:h,buttons:[{btnClass:"btn-default pull-left",dataAttributes:{method:"preview"},icon:"actions-view",text:c},{btnClass:"btn-default",dataAttributes:{method:"dismiss"},icon:"actions-close",text:e},{btnClass:"btn-primary",dataAttributes:{method:"save"},icon:"actions-document-save",text:f}],callback:function(a){a.find(".t3js-modal-body").addClass("cropper")},content:g,size:d.sizes.full,style:d.styles.dark,title:b,type:"ajax"}),this.currentModal.on("hide.bs.modal",function(b){a.destroy()}),this.currentModal.data("bs.modal").options.backdrop="static"},a.prototype.init=function(){var b=this,d=this.currentModal.find(this.cropImageSelector),e=c(d).height(),f=c(d).width(),g=this.trigger.attr("data-crop-variants");if(!g)throw new TypeError("ImageManipulation: No cropVariants data found for image");this.data=c.isEmptyObject(this.data)?JSON.parse(g):this.data,this.currentModal.find(this.cropImageContainerSelector).css({height:e,width:f}),this.cropVariantTriggers=this.currentModal.find(".t3js-crop-variant-trigger"),this.activeCropVariantTrigger=this.currentModal.find(".t3js-crop-variant-trigger.is-active"),this.cropInfo=this.currentModal.find(this.cropInfoSelector),this.saveButton=this.currentModal.find("[data-method=save]"),this.previewButton=this.currentModal.find("[data-method=preview]"),this.dismissButton=this.currentModal.find("[data-method=dismiss]"),this.resetButton=this.currentModal.find("[data-method=reset]"),this.cropperCanvas=this.currentModal.find("#js-crop-canvas"),this.aspectRatioTrigger=this.currentModal.find("[data-method=setAspectRatio]"),this.currentCropVariant=this.data[this.activeCropVariantTrigger.attr("data-crop-variant-id")],this.cropVariantTriggers.off("click").on("click",function(a){if(c(a.currentTarget).hasClass("is-active"))return a.stopPropagation(),void a.preventDefault();b.activeCropVariantTrigger.removeClass("is-active"),c(a.currentTarget).addClass("is-active"),b.activeCropVariantTrigger=c(a.currentTarget);var d=b.data[b.activeCropVariantTrigger.attr("data-crop-variant-id")],e=b.cropper.cropper("getImageData");d.cropArea=b.convertRelativeToAbsoluteCropArea(d.cropArea,e),b.currentCropVariant=c.extend(!0,{},d),b.update(d)}),this.aspectRatioTrigger.off("click").on("click",function(a){var d=c(a.currentTarget).attr("data-option"),e=c.extend(!0,{},b.currentCropVariant),f=e.allowedAspectRatios[d];b.setAspectRatio(f),b.setCropArea(e.cropArea),b.currentCropVariant=c.extend(!0,{},e,{selectedRatio:d}),b.update(b.currentCropVariant)}),this.saveButton.off("click").on("click",function(){b.save(b.data)}),this.trigger.attr("data-preview-url")?this.previewButton.off("click").on("click",function(){b.openPreview(b.data)}):this.previewButton.hide(),this.dismissButton.off("click").on("click",function(){b.currentModal.modal("hide")}),this.resetButton.off("click").on("click",function(a){var d=b.cropper.cropper("getImageData"),e=c(a.currentTarget).attr("data-crop-variant");if(a.preventDefault(),a.stopPropagation(),!e)throw new TypeError("TYPO3 Cropper: No cropVariant data attribute found on reset element.");var f=JSON.parse(e),g=b.convertRelativeToAbsoluteCropArea(f.cropArea,d);b.currentCropVariant=c.extend(!0,{},f,{cropArea:g}),b.update(b.currentCropVariant)}),a.isEmptyArea(this.currentCropVariant.cropArea)&&(this.defaultOpts=c.extend({autoCropArea:1},this.defaultOpts)),this.cropper=top.$(d).cropper(c.extend(this.defaultOpts,{built:this.cropBuiltHandler,crop:this.cropMoveHandler,cropend:this.cropEndHandler,cropstart:this.cropStartHandler,data:this.currentCropVariant.cropArea}))},a.prototype.update=function(b){var d=c.extend(!0,{},b),e=b.allowedAspectRatios[b.selectedRatio];this.currentModal.find("[data-option]").removeClass("active"),this.currentModal.find('[data-option="'+b.selectedRatio+'"]').addClass("active"),this.setAspectRatio(e),this.setCropArea(d.cropArea),this.currentCropVariant=c.extend(!0,{},d,b),this.cropBox.find(this.coverAreaSelector).remove(),this.cropBox.has(this.focusAreaSelector).length&&(this.focusArea.resizable("destroy").draggable("destroy"),this.focusArea.remove()),b.focusArea&&(a.isEmptyArea(b.focusArea)&&(this.currentCropVariant.focusArea=c.extend(!0,{},this.defaultFocusArea)),this.initFocusArea(this.cropBox),this.scaleAndMoveFocusArea(this.currentCropVariant.focusArea)),b.coverAreas&&this.initCoverAreas(this.cropBox,this.currentCropVariant.coverAreas),this.updatePreviewThumbnail(this.currentCropVariant,this.activeCropVariantTrigger)},a.prototype.initFocusArea=function(b){var d=this;this.focusArea=c('<div id="t3js-cropper-focus-area" class="cropper-focus-area"></div>'),b.append(this.focusArea),this.focusArea.draggable({containment:b,create:function(){d.scaleAndMoveFocusArea(d.currentCropVariant.focusArea)},drag:function(){var a=b.offset(),c=a.left,e=a.top,f=d.focusArea.offset(),g=f.left,h=f.top,i=d.currentCropVariant,j=i.focusArea,k=i.coverAreas;j.x=(g-c)/b.width(),j.y=(h-e)/b.height(),d.updatePreviewThumbnail(d.currentCropVariant,d.activeCropVariantTrigger),d.checkFocusAndCoverAreasCollision(j,k)?d.focusArea.addClass("has-nodrop"):d.focusArea.removeClass("has-nodrop")},revert:function(){var c=250,e=b.offset(),f=e.left,g=e.top,h=d.focusArea.offset(),i=h.left,j=h.top,k=d.currentCropVariant,l=k.focusArea,m=k.coverAreas;return!!d.checkFocusAndCoverAreasCollision(l,m)&&(d.focusArea.removeClass("has-nodrop"),a.wait(function(){l.x=(i-f)/b.width(),l.y=(j-g)/b.height(),d.updateCropVariantData(d.currentCropVariant)},c),!0)},revertDuration:200,stop:function(){var a=b.offset(),c=a.left,e=a.top,f=d.focusArea.offset(),g=f.left,h=f.top,i=d.currentCropVariant.focusArea;i.x=(g-c)/b.width(),i.y=(h-e)/b.height(),d.scaleAndMoveFocusArea(i)}}).resizable({containment:b,handles:"all",resize:function(){var a=b.offset(),c=a.left,e=a.top,f=d.focusArea.offset(),g=f.left,h=f.top,i=d.currentCropVariant,j=i.focusArea,k=i.coverAreas;j.height=d.focusArea.height()/b.height(),j.width=d.focusArea.width()/b.width(),j.x=(g-c)/b.width(),j.y=(h-e)/b.height(),d.updatePreviewThumbnail(d.currentCropVariant,d.activeCropVariantTrigger),d.checkFocusAndCoverAreasCollision(j,k)?d.focusArea.addClass("has-nodrop"):d.focusArea.removeClass("has-nodrop")},stop:function(a,e){var f=250,g=b.offset(),h=g.left,i=g.top,j=d.focusArea.offset(),k=j.left,l=j.top,m=d.currentCropVariant,n=m.focusArea,o=m.coverAreas;d.checkFocusAndCoverAreasCollision(n,o)?e.element.animate(c.extend(e.originalPosition,e.originalSize),f,function(){n.height=d.focusArea.height()/b.height(),n.height=d.focusArea.height()/b.height(),n.width=d.focusArea.width()/b.width(),n.x=(k-h)/b.width(),n.y=(l-i)/b.height(),d.scaleAndMoveFocusArea(n),d.focusArea.removeClass("has-nodrop")}):d.scaleAndMoveFocusArea(n)}})},a.prototype.initCoverAreas=function(b,d){d.forEach(function(d){var e=c('<div class="cropper-cover-area t3js-cropper-cover-area"></div>');b.append(e),e.css({height:a.toCssPercent(d.height),left:a.toCssPercent(d.x),top:a.toCssPercent(d.y),width:a.toCssPercent(d.width)})})},a.prototype.updatePreviewThumbnail=function(b,c){var d,e=c.find(".t3js-cropper-preview-thumbnail-crop-area"),f=c.find(".t3js-cropper-preview-thumbnail-crop-image"),g=c.find(".t3js-cropper-preview-thumbnail-focus-area"),h=this.cropper.cropper("getImageData");e.css({height:a.toCssPercent(b.cropArea.height/h.naturalHeight),left:a.toCssPercent(b.cropArea.x/h.naturalWidth),top:a.toCssPercent(b.cropArea.y/h.naturalHeight),width:a.toCssPercent(b.cropArea.width/h.naturalWidth)}),b.focusArea&&g.css({height:a.toCssPercent(b.focusArea.height),left:a.toCssPercent(b.focusArea.x),top:a.toCssPercent(b.focusArea.y),width:a.toCssPercent(b.focusArea.width)}),d=e.css(["width","height","left","top"]),f.css({height:parseFloat(d.height)*(1/(b.cropArea.height/h.naturalHeight))+"px",margin:-1*parseFloat(d.left)+"px",marginTop:-1*parseFloat(d.top)+"px",width:parseFloat(d.width)*(1/(b.cropArea.width/h.naturalWidth))+"px"})},a.prototype.scaleAndMoveFocusArea=function(b){this.focusArea.css({height:a.toCssPercent(b.height),left:a.toCssPercent(b.x),top:a.toCssPercent(b.y),width:a.toCssPercent(b.width)}),this.currentCropVariant.focusArea=b,this.updatePreviewThumbnail(this.currentCropVariant,this.activeCropVariantTrigger),this.updateCropVariantData(this.currentCropVariant)},a.prototype.updateCropVariantData=function(a){var b=this.cropper.cropper("getImageData"),d=this.convertAbsoluteToRelativeCropArea(a.cropArea,b);this.data[a.id]=c.extend(!0,{},a,{cropArea:d})},a.prototype.setAspectRatio=function(a){this.cropper.cropper("setAspectRatio",a.value)},a.prototype.setCropArea=function(a){var b=this.currentCropVariant.allowedAspectRatios[this.currentCropVariant.selectedRatio];0===b.value?this.cropper.cropper("setData",{height:a.height,width:a.width,x:a.x,y:a.y}):this.cropper.cropper("setData",{height:a.height,x:a.x,y:a.y})},a.prototype.checkFocusAndCoverAreasCollision=function(a,b){return!!b&&b.some(function(b){return a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.height+a.y>b.y})},a.prototype.convertAbsoluteToRelativeCropArea=function(a,b){var c=a.height,d=a.width,e=a.x,f=a.y;return{height:c/b.naturalHeight,width:d/b.naturalWidth,x:e/b.naturalWidth,y:f/b.naturalHeight}},a.prototype.convertRelativeToAbsoluteCropArea=function(a,b){var c=a.height,d=a.width,e=a.x,f=a.y;return{height:c*b.naturalHeight,width:d*b.naturalWidth,x:e*b.naturalWidth,y:f*b.naturalHeight}},a.prototype.setPreviewImages=function(a){var b=this,d=this.cropper,e=d.cropper("getImageData");Object.keys(a).forEach(function(f){var g=a[f],h=b.convertRelativeToAbsoluteCropArea(g.cropArea,e),i=b.trigger.closest(".form-group").find('.t3js-image-manipulation-preview[data-crop-variant-id="'+f+'"]'),j=b.trigger.closest(".form-group").find('.t3js-image-manipulation-selected-ratio[data-crop-variant-id="'+f+'"]');if(0!==i.length){var k=i.width(),l=i.data("preview-height"),m=h.width/h.height,n=k/m;n>l?k=l*m:l=n,k>h.width&&(k=h.width,l=h.height);var o=k/h.width,p=c("<div />").html('<img src="'+d.attr("src")+'">'),q=b.currentModal.find('.t3-js-ratio-title[data-ratio-id="'+g.id+g.selectedRatio+'"]');j.text(q.text()),p.addClass("cropper-preview-container"),i.empty().append(p),p.wrap('<span class="thumbnail thumbnail-status"></span>'),p.width(k).height(l).find("img").css({height:e.naturalHeight*o,left:-h.x*o,top:-h.y*o,width:e.naturalWidth*o})}})},a.prototype.openPreview=function(b){var c=a.serializeCropVariants(b),d=this.trigger.attr("data-preview-url");d=d+"&cropVariants="+encodeURIComponent(c),window.open(d,"TYPO3ImageManipulationPreview")},a.prototype.save=function(b){var d=a.serializeCropVariants(b),e=c("#"+this.trigger.attr("data-field"));this.trigger.attr("data-crop-variants",JSON.stringify(b)),this.setPreviewImages(b),e.val(d),this.currentModal.modal("hide")},a.prototype.destroy=function(){this.currentModal&&(this.cropper.cropper("destroy"),this.cropper=null,this.currentModal=null,this.data=null)},a.prototype.resizeEnd=function(a){var b,d=this;c(window).on("resize",function(){clearTimeout(b),b=setTimeout(function(){a()},d.resizeTimeout)})},a}();return new f});